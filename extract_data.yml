name: Process IPL Data

on:
  schedule:
    - cron: "0 0 * * *"  # Runs every day at midnight IST (adjust the schedule as needed)
  workflow_dispatch:  # Allows manual triggering

jobs:
  process_data:
    runs-on: ubuntu-latest

    steps:

      # Checkout the repository to start processing
      - name: Checkout repository
        uses: actions/checkout@v2
    
      # Set up Git to handle repository changes
      - name: Set up Git
        run: |
          git config --global user.name "iadityak0188"
          git config --global user.email "iadhi6336@gmail.com"
          git config --global url.https://${{ secrets.PAT_TOKEN }}@github.com/.insteadOf https://github.com/
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

      # Create necessary directories for JSON and ZIP files
      - name: Create json and zip directory
        run: mkdir -p json/cric_matches zip

      # Capture the list of files before downloading the new dataset
      - name: List files before
        id: list_files_before
        run: |
          ls -A json/cric_matches > files_before.txt

      # Download the IPL dataset zip file from the source
      - name: Download IPL dataset zip
        run: wget https://cricsheet.org/downloads/cricket_json.zip

      # Unzip the IPL dataset
      - name: Unzip IPL dataset
        run: unzip -q ipl_json.zip

      # Move the downloaded JSON and ZIP files to their respective folders
      - name: Move files to folders
        run: |
          mv *.json json/ipl_match
          echo "Json Files moved successfully"
          mv *.zip zip/
          echo "Zip Files moved successfully"

    

      # Set up Python for transforming the data 
      - name: Configure Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'
          architecture: 'x64'

      # List the files after downloading and extraction for verification
      - name: List files after
        id: list_files_after
        run: |
          ls -A json/cric_matches > files_after.txt
          wc -l files_after.txt

      # Check if there are any new files to commit and push to the repository
      - name: Check for new files
        id: new_files
        run: |
          diff_files=$(diff files_before.txt files_after.txt)
          diff_status=$?
          if [ $diff_status -eq 0 ]; then
            echo "No differences found."
            exit 0
          elif [ $diff_status -eq 1 ]; then
            echo "Differences found."
            exit 1
          else
            echo "Error encountered while comparing files."
            exit 2
          fi
        continue-on-error: true

      # Commit and push changes if new files are detected
      - name: Commit and push changes
        if: steps.new_files.outcome == 'failure'
        run: |
          git init
          git add json/ipl_match zip/
          git commit -m "files updated at - $(echo ${{ steps.timestamp.outputs.date }}) (IST)"
          git push --force https://github.com/iadityak0188/-cricket-dataset-extract.git main
      
      # Trigger Transform Workflow (if needed to run transformation tasks on the data)
      - name: Trigger Transform Workflow
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            -H "Accept: application/vnd.github.everest-preview+json" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/iadityak0188/-cricket-dataset-extract/dispatches \
            -d '{"event_type": "trigger-transform-workflow"}'

